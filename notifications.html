<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - Student Hub</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #334155;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            background: var(--bg-card);
            padding: 25px 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-outline {
            background: transparent;
            color: var(--text-primary);
            border: 2px solid var(--primary);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .tab {
            padding: 12px 24px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab:hover {
            border-color: var(--primary);
        }

        .tab.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        .tab-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: 700;
        }

        .notifications-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .notification {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--border);
            display: flex;
            gap: 15px;
            align-items: start;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .notification:hover {
            transform: translateX(5px);
            border-color: var(--primary);
        }

        .notification.unread {
            border-left: 4px solid var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .notification.unread::before {
            content: '';
            position: absolute;
            top: 20px;
            right: 20px;
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
        }

        .notif-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .notif-icon.friend-request {
            background: rgba(99, 102, 241, 0.2);
        }

        .notif-icon.message {
            background: rgba(16, 185, 129, 0.2);
        }

        .notif-icon.like {
            background: rgba(236, 72, 153, 0.2);
        }

        .notif-icon.comment {
            background: rgba(245, 158, 11, 0.2);
        }

        .notif-icon.system {
            background: rgba(99, 102, 241, 0.2);
        }

        .notif-content {
            flex: 1;
        }

        .notif-title {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .notif-message {
            color: var(--text-secondary);
            font-size: 0.95em;
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .notif-time {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .notif-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .notif-actions .btn {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        .mark-all-read {
            background: var(--bg-card);
            padding: 15px 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: var(--text-secondary);
            margin-top: 5px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üîî Notifications</h1>
                <p style="color: var(--text-secondary); margin-top: 5px;">Stay updated with everything</p>
            </div>
            <a href="student-dashboard.html" class="btn btn-outline">‚Üê Dashboard</a>
        </header>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalNotifs">0</div>
                <div class="stat-label">Total Notifications</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unreadNotifs">0</div>
                <div class="stat-label">Unread</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayNotifs">0</div>
                <div class="stat-label">Today</div>
            </div>
        </div>

        <div class="mark-all-read">
            <div>
                <strong>Manage Notifications</strong>
                <p style="font-size: 0.9em; color: var(--text-secondary); margin-top: 3px;">Keep your notifications organized</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="markAllRead()">Mark All Read</button>
                <button class="btn btn-outline" onclick="clearAll()">Clear All</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="filterNotifs('all')">
                All
                <span class="tab-badge" id="allBadge" style="display: none;">0</span>
            </div>
            <div class="tab" onclick="filterNotifs('friend-requests')">
                Friend Requests
                <span class="tab-badge" id="friendBadge" style="display: none;">0</span>
            </div>
            <div class="tab" onclick="filterNotifs('messages')">Messages</div>
            <div class="tab" onclick="filterNotifs('social')">Social</div>
            <div class="tab" onclick="filterNotifs('system')">System</div>
        </div>

        <div class="notifications-list" id="notificationsList"></div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-icon">üîï</div>
            <h2>No notifications yet</h2>
            <p>When you get notifications, they'll appear here</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config-rtdb.js"></script>

    <script>
        let currentUserId = null;
        let notifications = [];
        let currentFilter = 'all';

        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'login-rtdb.html';
                return;
            }
            currentUserId = user.uid;
            loadNotifications();
        });

        function loadNotifications() {
            database.ref(`users/${currentUserId}/notifications`).on('value', (snapshot) => {
                const notifs = snapshot.val() || {};
                notifications = Object.entries(notifs).map(([id, notif]) => ({
                    id,
                    ...notif
                })).sort((a, b) => b.timestamp - a.timestamp);

                updateStats();
                displayNotifications();
            });
        }

        function updateStats() {
            const unread = notifications.filter(n => !n.read).length;
            const today = notifications.filter(n => {
                const notifDate = new Date(n.timestamp).toDateString();
                const todayDate = new Date().toDateString();
                return notifDate === todayDate;
            }).length;

            document.getElementById('totalNotifs').textContent = notifications.length;
            document.getElementById('unreadNotifs').textContent = unread;
            document.getElementById('todayNotifs').textContent = today;

            // Update badges
            if (unread > 0) {
                document.getElementById('allBadge').textContent = unread;
                document.getElementById('allBadge').style.display = 'flex';
            } else {
                document.getElementById('allBadge').style.display = 'none';
            }

            const friendRequests = notifications.filter(n => n.type === 'friend-request' && !n.read).length;
            if (friendRequests > 0) {
                document.getElementById('friendBadge').textContent = friendRequests;
                document.getElementById('friendBadge').style.display = 'flex';
            } else {
                document.getElementById('friendBadge').style.display = 'none';
            }
        }

        function displayNotifications() {
            let filtered = notifications;

            if (currentFilter !== 'all') {
                if (currentFilter === 'friend-requests') {
                    filtered = notifications.filter(n => n.type === 'friend-request');
                } else if (currentFilter === 'messages') {
                    filtered = notifications.filter(n => n.type === 'message');
                } else if (currentFilter === 'social') {
                    filtered = notifications.filter(n => ['like', 'comment', 'post'].includes(n.type));
                } else if (currentFilter === 'system') {
                    filtered = notifications.filter(n => n.type === 'system');
                }
            }

            const container = document.getElementById('notificationsList');
            const emptyState = document.getElementById('emptyState');

            if (filtered.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'flex';
            emptyState.style.display = 'none';

            const html = filtered.map(notif => {
                const icons = {
                    'friend-request': 'üë•',
                    'message': 'üí¨',
                    'like': '‚ù§Ô∏è',
                    'comment': 'üí≠',
                    'post': 'üìù',
                    'system': '‚öôÔ∏è'
                };

                const icon = icons[notif.type] || 'üîî';
                const timeAgo = getTimeAgo(notif.timestamp);

                let actions = '';
                if (notif.type === 'friend-request' && !notif.actioned) {
                    actions = `
                        <div class="notif-actions">
                            <button class="btn btn-primary" onclick="acceptFriendRequest('${notif.fromUserId}', '${notif.id}')">Accept</button>
                            <button class="btn btn-outline" onclick="declineFriendRequest('${notif.id}')">Decline</button>
                        </div>
                    `;
                }

                return `
                    <div class="notification ${!notif.read ? 'unread' : ''}" onclick="handleNotificationClick('${notif.id}', '${notif.type}', '${notif.link || ''}')">
                        <div class="notif-icon ${notif.type}">
                            ${icon}
                        </div>
                        <div class="notif-content">
                            <div class="notif-title">${notif.title}</div>
                            <div class="notif-message">${notif.message}</div>
                            <div class="notif-time">${timeAgo}</div>
                            ${actions}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function filterNotifs(filter) {
            currentFilter = filter;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.currentTarget.classList.add('active');
            displayNotifications();
        }

        async function handleNotificationClick(notifId, type, link) {
            // Mark as read
            await database.ref(`users/${currentUserId}/notifications/${notifId}/read`).set(true);

            // Navigate if there's a link
            if (link) {
                window.location.href = link;
            }
        }

        async function markAllRead() {
            const updates = {};
            notifications.forEach(notif => {
                updates[`users/${currentUserId}/notifications/${notif.id}/read`] = true;
            });
            await database.ref().update(updates);
        }

        async function clearAll() {
            if (!confirm('Clear all notifications? This cannot be undone.')) return;
            await database.ref(`users/${currentUserId}/notifications`).remove();
        }

        async function acceptFriendRequest(friendId, notifId) {
            try {
                await database.ref(`users/${currentUserId}/friends/${friendId}`).set(true);
                await database.ref(`users/${friendId}/friends/${currentUserId}`).set(true);
                await database.ref(`users/${currentUserId}/friendRequests/${friendId}`).remove();
                await database.ref(`users/${currentUserId}/notifications/${notifId}/actioned`).set(true);
                alert('Friend request accepted!');
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function declineFriendRequest(notifId) {
            await database.ref(`users/${currentUserId}/notifications/${notifId}/actioned`).set(true);
            await database.ref(`users/${currentUserId}/notifications/${notifId}/read`).set(true);
        }

        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'Just now';
        }

        // Helper function to create notification (call from other pages)
        async function createNotification(userId, notification) {
            await database.ref(`users/${userId}/notifications`).push({
                ...notification,
                timestamp: Date.now(),
                read: false,
                actioned: false
            });
        }
    </script>
</body>
</html>